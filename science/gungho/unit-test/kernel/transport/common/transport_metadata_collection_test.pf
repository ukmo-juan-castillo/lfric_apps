!-----------------------------------------------------------------------------
! (c) Crown copyright 2022 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the transport metadata collection object
!>
module transport_metadata_collection_test

  use constants_mod,                  only : r_def, i_def, l_def, str_def, r_tran
  use transport_enumerated_types_mod, only : equation_form_advective,        &
                                             equation_form_conservative,     &
                                             splitting_none,                 &
                                             splitting_strang_vhv,           &
                                             splitting_strang_hvh,           &
                                             scheme_mol_3d,                  &
                                             scheme_split,                   &
                                             split_method_mol,               &
                                             split_method_sl,                &
                                             monotone_none,                  &
                                             vertical_monotone_order_linear, &
                                             special_edges_monotone_none,    &
                                             ffsl_splitting_swift
  use transport_metadata_collection_mod, &
                                      only : transport_metadata_collection_type, &
                                             transport_metadata_collection
  use transport_metadata_mod,         only : transport_metadata_type
  use funit

  implicit none

  private
  public :: test_all

  @TestCase
  type, extends(TestCase), public :: transport_metadata_collection_test_type
    private

    integer, allocatable :: dummy_for_gcc

  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type transport_metadata_collection_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    use feign_config_mod,     only : feign_transport_config
    use transport_config_mod, only : runge_kutta_method_ssp2,       &
                                     operators_fv,                  &
                                     slice_order_cubic,             &
                                     si_outer_transport_none,       &
                                     vertical_sl_order_quintic,     &
                                     max_vert_cfl_calc_uniform,     &
                                     horizontal_monotone,           &
                                     vertical_monotone,             &
                                     vertical_monotone_order,       &
                                     substep_transport_off,         &
                                     theta_variable_dry,            &
                                     min_val_method_iterative,      &
                                     calculate_detj_upwind,         &
                                     panel_edge_treatment_none

    implicit none

    class(transport_metadata_collection_test_type), intent(inout) :: this

    ! We only going to use the field names in this unit-test,
    ! which are checked by the transport_metadata_collection
    ! All the other options are unused so don't matter
    call feign_transport_config(                           &
      field_names = (/ 'do', 're', 'mi' /),                &
      profile_size = 3,                                    &
      transport_ageofair=.false.,                          &
      ageofair_reset_level = 10,                           &
      equation_form = (/ 1, 1, 2 /),                       &
      scheme = (/ 1, 1, 1 /),                              &
      splitting = (/1, 1, 1/),                             &
      horizontal_method = (/ 1, 1, 1 /),                   &
      vertical_method = (/ 1, 1, 1 /),                     &
      horizontal_monotone = (/ 1, 1, 1 /),                 &
      vertical_monotone = (/ 1, 1, 1 /),                   &
      vertical_monotone_order = (/ 1, 1, 1 /),             &
      log_space = (/ .false., .false., .false. /),         &
      enforce_min_value = (/ .false., .false., .false. /), &
      min_value = (/ 0.0_r_def, 0.0_r_def, 0.0_r_def /),   &
      ffsl_splitting = (/ 1, 1, 1 /),                      &
      operators = operators_fv,                            &
      runge_kutta_method = runge_kutta_method_ssp2,        &
      calculate_detj = calculate_detj_upwind,              &
      dep_pt_stencil_extent = 2,                           &
      ffsl_inner_order = 0,                                &
      ffsl_outer_order = 1,                                &
      ffsl_vertical_order = (/ 1, 1, 1 /),                 &
      ffsl_unity_3d = .true.,                              &
      fv_vertical_order = 2,                               &
      fv_horizontal_order = 2,                             &
      min_val_abs_tol = -1.0e-12_r_def,                    &
      min_val_max_iterations = 100,                        &
      min_val_method = min_val_method_iterative,           &
      wind_mono_top = .false.,                             &
      wind_mono_top_depth = 0,                             &
      adjust_theta = .false.,                              &
      adjust_theta_above = 0.0_r_def,                      &
      adjust_tracer_equation = .false.,                    &
      adjust_vhv_wind=.false.,                             &
      broken_w2_projection = .false.,                      &
      consistent_metric  = .false.,                        &
      oned_reconstruction = .false.,                       &
      cfl_mol_1d_stab = 1.0_r_def,                         &
      cfl_mol_2d_stab = 1.0_r_def,                         &
      cfl_mol_3d_stab = 1.0_r_def,                         &
      cheap_update = .false.,                              &
      dry_field_name = 'do',                               &
      slice_order = slice_order_cubic,                     &
      vertical_sl_order = vertical_sl_order_quintic,       &
      si_outer_transport = si_outer_transport_none,        &
      substep_transport = substep_transport_off,           &
      theta_variable=theta_variable_dry,                   &
      theta_dispersion_correction  = .false.,              &
      use_density_predictor = .false.,                     &
      cap_density_predictor = 0.001_r_def,                 &
      max_vert_cfl_calc = max_vert_cfl_calc_uniform,       &
      reversible = (/ .false., .false., .false. /),        &
      panel_edge_treatment = panel_edge_treatment_none,    &
      panel_edge_high_order = .false.,                     &
      special_edges_monotone = (/ 0, 0, 0 /)               &
    )


    ! Create top level function space collection
    transport_metadata_collection = transport_metadata_collection_type()

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    use configuration_mod, only: final_configuration

    implicit none

    class(transport_metadata_collection_test_type), intent(inout) :: this

    call transport_metadata_collection%clear()
    call final_configuration()

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  @test
  subroutine test_all( this )


    implicit none

    class(transport_metadata_collection_test_type), intent(inout) :: this

    real(kind=r_tran),             parameter :: tol = 1.0e-12_r_tran
    real(kind=r_tran),             parameter :: zero_min_value = 0.0_r_tran
    logical(kind=l_def),           parameter :: no_enforce_min_value = .false.
    logical(kind=l_def),           parameter :: no_logspace = .false.
    real(kind=r_tran),             parameter :: one_min_value = 1.0_r_tran
    logical(kind=l_def),           parameter :: enforce_min_value = .true.
    logical(kind=l_def),           parameter :: logspace = .true.
    logical(kind=l_def),           parameter :: reversible = .true.
    integer(kind=i_def),           parameter :: ffsl_vertical_order = 2
    type(transport_metadata_type), pointer   :: metadata_ptr
    type(transport_metadata_type)            :: metadata
    character(len=str_def)                   :: fname

    ! Add two metadata objects and then get them
    fname = 'do'
    metadata = transport_metadata_type(fname,                          &
                                       equation_form_advective,        &
                                       splitting_none,                 &
                                       scheme_mol_3d,                  &
                                       split_method_mol,               &
                                       split_method_mol,               &
                                       monotone_none,                  &
                                       monotone_none,                  &
                                       vertical_monotone_order_linear, &
                                       special_edges_monotone_none,    &
                                       no_enforce_min_value,           &
                                       zero_min_value,                 &
                                       no_logspace,                    &
                                       reversible,                     &
                                       ffsl_splitting_swift,           &
                                       ffsl_vertical_order)

    call transport_metadata_collection%set_transport_metadata(metadata)

    fname = 're'
    metadata = transport_metadata_type(fname,                          &
                                       equation_form_conservative,     &
                                       splitting_strang_vhv,           &
                                       scheme_split,                   &
                                       split_method_mol,               &
                                       split_method_mol,               &
                                       monotone_none,                  &
                                       monotone_none,                  &
                                       vertical_monotone_order_linear, &
                                       special_edges_monotone_none,    &
                                       no_enforce_min_value,           &
                                       zero_min_value,                 &
                                       no_logspace,                    &
                                       reversible,                     &
                                       ffsl_splitting_swift,           &
                                       ffsl_vertical_order)

    call transport_metadata_collection%set_transport_metadata(metadata)

    fname = 'mi'
    metadata = transport_metadata_type(fname,                          &
                                       equation_form_conservative,     &
                                       splitting_strang_hvh,           &
                                       scheme_split,                   &
                                       split_method_mol,               &
                                       split_method_sl,                &
                                       monotone_none,                  &
                                       monotone_none,                  &
                                       vertical_monotone_order_linear, &
                                       special_edges_monotone_none,    &
                                       enforce_min_value,              &
                                       one_min_value,                  &
                                       logspace,                       &
                                       reversible,                     &
                                       ffsl_splitting_swift,           &
                                       ffsl_vertical_order)

    call transport_metadata_collection%set_transport_metadata(metadata)

    ! Get metadata
    fname = 'do'
    metadata_ptr => transport_metadata_collection%get_transport_metadata(fname)
    @assertEqual(fname, metadata_ptr%get_name())
    @assertEqual(equation_form_advective, metadata_ptr%get_equation_form())
    @assertEqual(splitting_none, metadata_ptr%get_splitting())
    @assertEqual(scheme_mol_3d, metadata_ptr%get_scheme())
    @assertEqual(no_enforce_min_value, metadata_ptr%get_enforce_min_value())
    @assertEqual(zero_min_value, metadata_ptr%get_min_value(), tol)
    @assertEqual(no_logspace, metadata_ptr%get_log_space())

    fname = 're'
    metadata_ptr => transport_metadata_collection%get_transport_metadata(fname)
    @assertEqual(fname, metadata_ptr%get_name())
    @assertEqual(equation_form_conservative, metadata_ptr%get_equation_form())
    @assertEqual(splitting_strang_vhv, metadata_ptr%get_splitting())
    @assertEqual(scheme_split, metadata_ptr%get_scheme())
    @assertEqual(no_enforce_min_value, metadata_ptr%get_enforce_min_value())
    @assertEqual(zero_min_value, metadata_ptr%get_min_value(), tol)
    @assertEqual(no_logspace, metadata_ptr%get_log_space())

    fname = 'mi'
    metadata_ptr => transport_metadata_collection%get_transport_metadata(fname)
    @assertEqual(fname, metadata_ptr%get_name())
    @assertEqual(equation_form_conservative, metadata_ptr%get_equation_form())
    @assertEqual(splitting_strang_hvh, metadata_ptr%get_splitting())
    @assertEqual(scheme_split, metadata_ptr%get_scheme())
    @assertEqual(enforce_min_value, metadata_ptr%get_enforce_min_value())
    @assertEqual(one_min_value, metadata_ptr%get_min_value(), tol)
    @assertEqual(logspace, metadata_ptr%get_log_space())

  end subroutine test_all

end module transport_metadata_collection_test
